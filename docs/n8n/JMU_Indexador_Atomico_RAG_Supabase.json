{
    "name":  "JMU_Indexador_Atomico_RAG_Supabase (TESTE)",
    "nodes":  [
                  {
                      "parameters":  {
                                         "httpMethod":  "POST",
                                         "path":  "index-norma-rag",
                                         "responseMode":  "onReceived",
                                         "options":  {

                                                     }
                                     },
                      "id":  "webhook-trigger",
                      "name":  "Webhook (Recebe PDF)",
                      "type":  "n8n-nodes-base.webhook",
                      "typeVersion":  1,
                      "position":  [
                                       464,
                                       352
                                   ]
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "// Usa a entrada real do webhook (evita interferÃªncia de dados fixados)\nconst input = $input.first().json;\nconst fullText = input.body?.text || input.text || \"Texto de exemplo da norma...\";\nconst normaId = input.body?.norma_id || input.body?.normaId || input.body?.norma_vigente || input.body?.normaVigente || input.body?.identificador || input.body?.assunto || input.norma_id || input.norma_vigente || input.assunto || null;\nconst chunkSize = 4000;\nconst chunks = [];\n\nfor (let i = 0, o = 0; i \u003c fullText.length; i += chunkSize, o++) {\n  chunks.push({\n    json: {\n      chunk_id: o + 1,\n      text_content: fullText.substr(i, chunkSize),\n      total_chunks: Math.ceil(fullText.length / chunkSize),\n      norma_id: normaId\n    }\n  });\n}\n\nreturn chunks;"
                                     },
                      "id":  "code-chunking",
                      "name":  "Fatiador de Texto (Chunking)",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  1,
                      "position":  [
                                       688,
                                       352
                                   ]
                  },
                  {
                      "parameters":  {
                                         "authentication":  "serviceAccount",
                                         "operation":  "append",
                                         "documentId":  {
                                                            "__rl":  true,
                                                            "value":  "1Emu8IWDuS4yIS_8vQ_wPrZPqCNTkUBfMQFuVYWvFHVI",
                                                            "mode":  "id"
                                                        },
                                         "sheetName":  {
                                                           "__rl":  true,
                                                           "value":  "PÃ¡gina1",
                                                           "mode":  "name"
                                                       },
                                         "dataMode":  "autoMapInputData",
                                         "options":  {

                                                     }
                                     },
                      "id":  "google-sheets",
                      "name":  "Salvar na Planilha",
                      "type":  "n8n-nodes-base.googleSheets",
                      "typeVersion":  3,
                      "position":  [
                                       1328,
                                       352
                                   ],
                      "credentials":  {
                                          "googleApi":  {
                                                            "name":  "Google Sheets - JMU Automation (Service Account)"
                                                        }
                                      },
                      "continueOnFail":  false
                  },
                  {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
                                         "authentication":  "genericCredentialType",
                                         "genericAuthType":  "httpHeaderAuth",
                                         "sendBody":  true,
                                         "specifyBody":  "json",
                                         "jsonBody":  "={\"contents\":[{\"parts\":[{\"text\":\"{{$json.text_content}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}",
                                         "options":  {

                                                     }
                                     },
                      "id":  "408c24fc-1603-48ae-b5f5-ffbff1771e04",
                      "name":  "Gemini (Indexador)",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.1,
                      "position":  [
                                       960,
                                       400
                                   ],
                      "credentials":  {
                                          "httpHeaderAuth":  {
                                                                 "name":  "Gemini API Key Header"
                                                             }
                                      },
                      "continueOnFail":  false
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "// Parse Gemini response (JSON) if possible; otherwise fall back to the raw chunk.\n// This guarantees embedding_text is never empty (or the item is skipped).\nreturn $input.all().flatMap(item =\u003e {\n  const json = item?.json ?? {};\n\n  const chunkTextRaw = json.text_content ?? json.body?.text_content ?? json.input?.text_content ?? \u0027\u0027;\n  const chunkText = String(chunkTextRaw ?? \u0027\u0027).trim();\n\n  const rawCandidate =\n    json?.candidates?.[0]?.content?.parts?.[0]?.text ??\n    json?.body?.candidates?.[0]?.content?.parts?.[0]?.text ??\n    json?.data?.candidates?.[0]?.content?.parts?.[0]?.text ??\n    null;\n\n  let parsed = {};\n  let rawText = null;\n\n  if (typeof rawCandidate === \u0027string\u0027) {\n    rawText = rawCandidate.trim();\n\n    // Strip optional Markdown code fences.\n    const fenced = rawText\n      .replace(/^```(?:json)?/i, \u0027\u0027)\n      .replace(/```$/i, \u0027\u0027)\n      .trim();\n\n    // Try to extract the first JSON object.\n    const match = fenced.match(/\\{[\\s\\S]*\\}/);\n    const maybeJson = match ? match[0] : fenced;\n\n    try {\n      parsed = JSON.parse(maybeJson);\n    } catch {\n      parsed = {};\n    }\n  }\n\n  const article = parsed.article_number ?? parsed.article ?? \u0027\u0027;\n  const deadlineValue = parsed.deadline_days ?? parsed.deadline?.value;\n  const deadlineUnit = parsed.deadline?.unit ?? \u0027dias\u0027;\n\n  const tags = parsed.Tags_Pentagonais ?? parsed.tags_pentagonais ?? parsed.tags ?? \u0027\u0027;\n  const tagsValue = Array.isArray(tags) ? tags.join(\u0027, \u0027) : String(tags ?? \u0027\u0027);\n\n  const prazo =\n    parsed.Prazos_Gatilhos ??\n    parsed.prazos_gatilhos ??\n    (deadlineValue ? `${deadlineValue} ${deadlineUnit}` : \u0027N/A\u0027);\n\n  const conteudo =\n    parsed.Conteudo_Integral ??\n    parsed.conteudo_integral ??\n    parsed.original_text ??\n    \u0027\u0027;\n\n  const conteudoFinal = String(conteudo ?? \u0027\u0027).trim() || chunkText;\n\n  const resumo =\n    parsed.Resumo_Interpretativo ??\n    parsed.resumo_interpretativo ??\n    parsed.purpose ??\n    conteudoFinal;\n\n  const embeddingText = String(conteudoFinal ?? \u0027\u0027).trim() || String(resumo ?? \u0027\u0027).trim() || chunkText;\n  if (!embeddingText) return [];\n\n  const chunkIdNum = Number(json.chunk_id ?? 1);\n  const chunkIndexFromJson = Number(json.chunk_index);\n  const chunkIndex = Number.isFinite(chunkIndexFromJson)\n    ? chunkIndexFromJson\n    : (Number.isFinite(chunkIdNum) ? (chunkIdNum - 1) : 0);\n\n  const normaIdFromChunk =\n    json.norma_id ??\n    json.body?.norma_id ??\n    json.body?.normaId ??\n    json.body?.norma_vigente ??\n    json.body?.normaVigente ??\n    null;\n\n  const normaId = normaIdFromChunk ??\n    (String(parsed.Identificador ?? parsed.identificador ?? \u0027\u0027).split(\u0027-C\u0027)[0] || \u0027UNKNOWN\u0027);\n\n  const identificadorChunk = parsed.Identificador ?? parsed.identificador ?? String(json.chunk_id ?? 1);\n\n  return [{\n    json: {\n      Identificador: parsed.Identificador ?? parsed.identificador ?? String(json.chunk_id ?? 1),\n      Dispositivo: parsed.Dispositivo ?? parsed.dispositivo ?? (article ? `Art. ${article}` : \u0027\u0027),\n      Status_Vigencia: parsed.Status_Vigencia ?? parsed.status_vigencia ?? \u0027Vigente\u0027,\n      Conteudo_Integral: conteudoFinal,\n      Resumo_Interpretativo: resumo,\n      Prazos_Gatilhos: prazo,\n      Normas_Alteradoras: parsed.Normas_Alteradoras ?? parsed.normas_alteradoras ?? \u0027N/A\u0027,\n      Tags_Pentagonais: tagsValue || \u0027N/A\u0027,\n\n      // RAG/Supabase fields\n      norma_id: normaId,\n      chunk_index: chunkIndex,\n      conteudo_texto: conteudoFinal,\n      embedding_text: embeddingText,\n      metadata: {\n        origem: \u0027pipeline_a\u0027,\n        drive_folder_id: \u00271QEZGPtlmg2ladDSyFdv7S7foNSpgiaqk\u0027,\n        dispositivo: parsed.Dispositivo ?? parsed.dispositivo ?? (article ? `Art. ${article}` : \u0027\u0027),\n        status_vigencia: parsed.Status_Vigencia ?? parsed.status_vigencia ?? \u0027Vigente\u0027,\n        tags_pentagonais: tagsValue || \u0027N/A\u0027,\n        identificador_chunk: identificadorChunk,\n        gemini_raw_present: Boolean(rawText),\n        chunk_text_len: chunkText.length,\n        embedding_text_len: embeddingText.length,\n      }\n    }\n  }];\n});"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       1168,
                                       400
                                   ],
                      "id":  "7ffd4620-65ad-4a19-b888-9a98944fe547",
                      "name":  "Code in JavaScript"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "return [];"
                                     },
                      "id":  "7ad30698-7a2f-4ebf-82ec-96e1ccf8a2f4",
                      "name":  "Bloquear Escrita Direta",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       928,
                                       240
                                   ],
                      "alwaysOutputData":  false
                  },
                  {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:embedContent",
                                         "authentication":  "genericCredentialType",
                                         "genericAuthType":  "httpHeaderAuth",
                                         "sendBody":  true,
                                         "specifyBody":  "json",
                                         "jsonBody":  "={\"content\":{\"parts\":[{\"text\":\"{{$json.embedding_text}}\"}]},\"outputDimensionality\":768}",
                                         "options":  {

                                                     }
                                     },
                      "id":  "8b0cd5dc-31d2-4104-b6e8-f4d5dad2880e",
                      "name":  "Gemini (Embeddings)",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.1,
                      "position":  [
                                       1328,
                                       520
                                   ],
                      "credentials":  {
                                          "httpHeaderAuth":  {
                                                                 "name":  "Gemini API Key Header"
                                                             }
                                      },
                      "continueOnFail":  false
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "={{ (() =\u003e {   const normaId = String($json.norma_id ?? \u0027UNKNOWN\u0027);   const chunkIndex = Number($json.chunk_index ?? 0);   const conteudo = String($json.conteudo_texto ?? \u0027\u0027).replace(/\u0027/g, \"\u0027\u0027\");   const meta = JSON.stringify($json.metadata ?? {}).replace(/\u0027/g, \"\u0027\u0027\");   const values = ($json.embedding?.values ?? $json.body?.embedding?.values ?? $json.data?.embedding?.values ?? []);   const embeddingSql = (Array.isArray(values) \u0026\u0026 values.length) ? (`\u0027[` + values.join(\u0027,\u0027) + `]\u0027::vector`) : \u0027NULL\u0027;   return `insert into adminlog.normas_index (norma_id, chunk_index, conteudo_texto, embedding, metadata) values (\u0027${normaId}\u0027, ${chunkIndex}, \u0027${conteudo}\u0027, ${embeddingSql}, \u0027${meta}\u0027::jsonb);`; })() }}",
                                         "options":  {

                                                     }
                                     },
                      "id":  "7b5ddf30-4e95-471c-b23b-adc968bb9b9a",
                      "name":  "Supabase (Normas) - Insert",
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       1560,
                                       520
                                   ],
                      "credentials":  {
                                          "postgres":  {
                                                           "name":  "Supabase Postgres - jmu-db (pooler allowUnauthorizedCerts)"
                                                       }
                                      },
                      "continueOnFail":  false
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "={{ (() =\u003e {   const prompt = String($json.embedding_text ?? \u0027\u0027).slice(0, 4000).replace(/\u0027/g, \"\u0027\u0027\");   const values = ($json.embedding?.values ?? $json.body?.embedding?.values ?? $json.data?.embedding?.values ?? []);   const dim = Array.isArray(values) ? values.length : null;   const out = JSON.stringify({embedding_dim: dim}).replace(/\u0027/g, \"\u0027\u0027\");   const tokens = ($json.usageMetadata?.totalTokenCount ?? $json.body?.usageMetadata?.totalTokenCount ?? null);   const tokensSql = (tokens === null || tokens === undefined) ? \u0027NULL\u0027 : String(Number(tokens));   return `insert into adminlog.ai_generation_log (input_prompt, output_response, model_used, tokens_used) values (\u0027${prompt}\u0027, \u0027${out}\u0027, \u0027gemini-embedding-001\u0027, ${tokensSql});`; })() }}",
                                         "options":  {

                                                     }
                                     },
                      "id":  "5adfd9c2-6fa9-4d00-b99b-752b50054764",
                      "name":  "Supabase (Log) - Insert",
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       1760,
                                       520
                                   ],
                      "credentials":  {
                                          "postgres":  {
                                                           "name":  "Supabase Postgres - jmu-db (pooler allowUnauthorizedCerts)"
                                                       }
                                      },
                      "continueOnFail":  false
                  },
                  {
                      "id":  "11bda8d3-aedd-4da9-b423-d3b9eb62ce1a",
                      "name":  "Merge (Dados + Embedding)",
                      "type":  "n8n-nodes-base.merge",
                      "typeVersion":  3,
                      "position":  [
                                       1520,
                                       520
                                   ],
                      "parameters":  {
                                         "mode":  "combine",
                                         "combineBy":  "combineByPosition",
                                         "options":  {

                                                     }
                                     }
                  },
                  {
                      "id":  "b0972f9c-1133-41de-aa76-73bb5587263c",
                      "name":  "Merge (Chunk + Gemini)",
                      "type":  "n8n-nodes-base.merge",
                      "typeVersion":  3,
                      "position":  [
                                       1080,
                                       320
                                   ],
                      "parameters":  {
                                         "mode":  "combine",
                                         "combineBy":  "combineByPosition",
                                         "options":  {

                                                     }
                                     }
                  }
              ],
    "connections":  {
                        "Webhook (Recebe PDF)":  {
                                                     "main":  [
                                                                  [
                                                                      {
                                                                          "node":  "Fatiador de Texto (Chunking)",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ]
                                                              ]
                                                 },
                        "Fatiador de Texto (Chunking)":  {
                                                             "main":  [
                                                                          [
                                                                              {
                                                                                  "node":  "Gemini (Indexador)",
                                                                                  "type":  "main",
                                                                                  "index":  0
                                                                              },
                                                                              {
                                                                                  "node":  "Bloquear Escrita Direta",
                                                                                  "type":  "main",
                                                                                  "index":  0
                                                                              },
                                                                              {
                                                                                  "node":  "Merge (Chunk + Gemini)",
                                                                                  "type":  "main",
                                                                                  "index":  0
                                                                              }
                                                                          ]
                                                                      ]
                                                         },
                        "Gemini (Indexador)":  {
                                                   "main":  [
                                                                [
                                                                    {
                                                                        "node":  "Merge (Chunk + Gemini)",
                                                                        "type":  "main",
                                                                        "index":  1
                                                                    }
                                                                ]
                                                            ]
                                               },
                        "Code in JavaScript":  {
                                                   "main":  [
                                                                [
                                                                    {
                                                                        "node":  "Salvar na Planilha",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    },
                                                                    {
                                                                        "node":  "Gemini (Embeddings)",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    },
                                                                    {
                                                                        "node":  "Merge (Dados + Embedding)",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
                                               },
                        "Bloquear Escrita Direta":  {
                                                        "main":  [
                                                                     [
                                                                         {
                                                                             "node":  "Salvar na Planilha",
                                                                             "type":  "main",
                                                                             "index":  0
                                                                         }
                                                                     ]
                                                                 ]
                                                    },
                        "Gemini (Embeddings)":  {
                                                    "main":  [
                                                                 [
                                                                     {
                                                                         "node":  "Merge (Dados + Embedding)",
                                                                         "type":  "main",
                                                                         "index":  1
                                                                     }
                                                                 ]
                                                             ]
                                                },
                        "Supabase (Normas) - Insert":  {
                                                           "main":  [
                                                                        [
                                                                            {
                                                                                "node":  "Supabase (Log) - Insert",
                                                                                "type":  "main",
                                                                                "index":  0
                                                                            }
                                                                        ]
                                                                    ]
                                                       },
                        "Merge (Dados + Embedding)":  {
                                                          "main":  [
                                                                       [
                                                                           {
                                                                               "node":  "Supabase (Normas) - Insert",
                                                                               "type":  "main",
                                                                               "index":  0
                                                                           }
                                                                       ]
                                                                   ]
                                                      },
                        "Merge (Chunk + Gemini)":  {
                                                       "main":  [
                                                                    [
                                                                        {
                                                                            "node":  "Code in JavaScript",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
                                                   }
                    },
    "settings":  {
                     "callerPolicy":  "workflowsFromSameOwner",
                     "availableInMCP":  false
                 },
    "staticData":  {

                   }
}
